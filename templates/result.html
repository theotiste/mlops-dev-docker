<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Résultat de prédiction</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0b1220; --card:#121a2a; --muted:#a6b0c3; --txt:#e9eefc;
           --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --border:#243149; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    body{margin:0;background:var(--bg);color:var(--txt)}
    .wrap{max-width:900px;margin:48px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .title{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--txt);padding:10px 12px;cursor:pointer}
    button.primary{background:#2563eb;border-color:#1f3d84}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:20px;border:1px solid var(--border)}
    .ok{background:#093225;border-color:#115e45}
    .warn{background:#3a2a08;border-color:#7c5c11}
    pre{white-space:pre-wrap;background:#0a1228;border:1px solid var(--border);border-radius:12px;padding:12px;max-height:50vh;overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Résultat de prédiction</h1>

    <section class="card">
      <div id="status" class="muted">Chargement…</div>

      <div class="grid" id="summary" style="display:none">
        <div>
          <h3>Décision</h3>
          <p><strong>Classe prédite :</strong> <span id="label_text">—</span></p>
          <p><span id="prob_pill" class="pill">p = <span id="proba">—</span></span></p>
          <p class="muted" id="meta"></p>
        </div>
        <div>
          <h3>Probabilités</h3>
          <table>
            <thead><tr><th>Classe</th><th>Probabilité</th></tr></thead>
            <tbody id="probs"></tbody>
          </table>
        </div>
      </div>

      <details style="margin-top:12px">
        <summary>Voir le JSON brut</summary>
        <pre id="raw">—</pre>
      </details>

      <div class="row" style="margin-top:14px">
        <button id="back" class="">← Revenir au formulaire</button>
        <button id="retry" class="primary">Refaire une prédiction</button>
      </div>
    </section>
  </div>

  <script>
    function fmtPct(x){ const n = Number(x); return Number.isFinite(n) ? (n*100).toFixed(2)+'%' : '—'; }
    function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

    function load(){
      const status = document.getElementById('status');
      const summary = document.getElementById('summary');
      const raw = document.getElementById('raw');
      const probsTbody = document.getElementById('probs');

      let data = {};
      try{ data = JSON.parse(sessionStorage.getItem('mlops:prediction') || '{}'); }catch{}

      if (!data || Object.keys(data).length===0){
        status.textContent = "Aucune prédiction trouvée dans cette session.";
        return;
      }

      // Résumé
      const label = data.label_text ?? (Array.isArray(data.labels) ? data.labels[0] : data.predictions);
      const pcls = (data.proba_predicted_class!=null) ? Number(data.proba_predicted_class) : NaN;

      document.getElementById('label_text').textContent = String(label ?? '—');
      document.getElementById('proba').textContent = fmtPct(pcls);

      // Couleur de la pastille (optionnel)
      const pill = document.getElementById('prob_pill');
      pill.classList.remove('ok','warn');
      if (Number.isFinite(pcls)){
        pill.classList.add(pcls >= 0.8 ? 'ok' : 'warn');
      }

      // Meta
      const bits = [];
      if (data.model_version) bits.push(`model_version: ${esc(data.model_version)}`);
      if (data.request_id)   bits.push(`request_id: ${esc(data.request_id)}`);
      if (data.latency_ms!=null) bits.push(`latency: ${Number(data.latency_ms).toFixed(0)} ms`);
      document.getElementById('meta').innerHTML = bits.join(' · ') || '';

      // Tableau des probabilités (si disponible)
      probsTbody.innerHTML = '';
      let probs = [];
      // supporte probabilities=[[p0,p1,...]] ou {B:0.3,M:0.7}
      if (Array.isArray(data.probabilities)){
        const arr = Array.isArray(data.probabilities[0]) ? data.probabilities[0] : data.probabilities;
        probs = arr.map((p,i)=>({ label: (data.labels_set?.[i] || ['B','M'][i] || `class_${i}`), p }));
      } else if (data.probabilities && typeof data.probabilities === 'object'){
        probs = Object.entries(data.probabilities).map(([k,v])=>({ label:k, p:v }));
      }
      for (const {label,p} of probs){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(label)}</td><td>${fmtPct(p)}</td>`;
        probsTbody.appendChild(tr);
      }

      // JSON brut
      raw.textContent = JSON.stringify(data, null, 2);

      status.textContent = "OK";
      summary.style.display = '';
    }

    document.getElementById('back').addEventListener('click', ()=>{
      // On laisse mlops:prefill tel quel (déjà posé par form) pour réafficher les valeurs
      window.location.href = './form_validated.html';
    });
    document.getElementById('retry').addEventListener('click', ()=>{
      // Nettoyage de l’ancienne prédiction seulement
      try{ sessionStorage.removeItem('mlops:prediction'); }catch{}
      window.location.href = './form_validated.html';
    });

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
