<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Prédiction du cancer du sein</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --card:#f7f8fb; --muted:#5b6678; --txt:#0b1220;
      --primary:#2563eb; --primary-2:#1d4ed8; --ring:#93c5fd;
      --border:#dbe2f1; --ok:#059669; --err:#dc2626; --warn:#b45309;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    body{margin:0;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1150px;margin:32px auto;padding:0 16px}
    h1{font-weight:800;letter-spacing:.25px;margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px;align-items:center}
    select,button{border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--txt);padding:10px 12px}
    button.btn{background:var(--primary);color:#fff;border:1px solid #1f3d84}
    button.btn:hover{background:var(--primary-2)}
    button.ghost{background:#fff}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:8px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .field label{font-weight:700;font-size:14px}
    .field input{border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--txt);
                 padding:10px 12px;outline:none}
    .field input:focus{border-color:var(--ring);box-shadow:0 0 0 3px #1e40af55}
    .hint{color:var(--muted);font-size:12px}
    .msg{margin-top:10px}
    .ok{color:var(--ok)} .error{color:var(--err)} .muted{color:var(--muted)} .warn{color:var(--warn)}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#fff}
    .spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .tip{text-align:center;color:var(--muted);font-size:13px;margin-top:6px}
    .result{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Prédiction du cancer du sein</h1>

    <section class="card">
      <div class="toolbar">
        <select id="ex-select" aria-label="Choisir un échantillon">
          <option value="0">Échantillon 1 (M)</option>
          <option value="1">Échantillon 2 (B)</option>
          <option value="2">Échantillon 3 (M)</option>
          <option value="3">Échantillon 4 (B)</option>
        </select>
        <button id="btn-load" class="ghost" type="button">Charger</button>
        <button id="btn-ex-fill" class="ghost" type="button">Tester l’échantillon</button>
        <button id="btn-clear" class="ghost" type="button">Effacer</button>
        <button id="btn-submit" class="btn" type="button">Lancer la prédiction</button>

        <span class="badge" id="cfg-badge"><span class="spinner" id="cfg-spin"></span> Chargement configuration…</span>
      </div>

      <form id="form" novalidate>
        <p class="muted" style="margin:0 0 10px">
          Saisissez les 30 caractéristiques. Les décimales peuvent être entrées avec
          <strong>virgule</strong> ou <strong>point</strong> (ex : <code>12,34</code> ou <code>12.34</code>).
        </p>

        <div id="fields" class="grid"><!-- auto-construit --></div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div class="muted">
            Appel API : <span class="mono">POST /predict</span> — URL lue depuis <code>/static/config.json</code>.
          </div>
          <div class="muted mono" id="api-url">(URL API inconnue)</div>
        </div>

        <p id="msg" class="msg muted"></p>

        <div id="result" class="result" style="display:none">
          <div class="row">
            <strong>Résultat</strong>
            <span id="res-badge" class="badge">—</span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>Prédiction : <strong id="res-y">—</strong></div>
            <div>Probabilités : <span class="mono" id="res-proba">—</span></div>
          </div>
        </div>

        <p class="tip">Astuce : utilisez <span class="mono">?sample=1</span> ou <span class="mono">?features=[...]</span> dans l’URL pour pré-remplir.</p>
      </form>
    </section>
  </div>

  <script>
    // -------- 1) Features --------
    const FEATURE_ORDER = [
      "radius_mean","texture_mean","perimeter_mean","area_mean",
      "smoothness_mean","compactness_mean","concavity_mean","concave points_mean",
      "symmetry_mean","fractal_dimension_mean",
      "radius_se","texture_se","perimeter_se","area_se","smoothness_se",
      "compactness_se","concavity_se","concave points_se","symmetry_se","fractal_dimension_se",
      "radius_worst","texture_worst","perimeter_worst","area_worst","smoothness_worst",
      "compactness_worst","concavity_worst","concave points_worst","symmetry_worst","fractal_dimension_worst"
    ];
    const FEATURE_LABELS = [
      "Radius Mean","Texture Mean","Perimeter Mean","Area Mean","Smoothness Mean","Compactness Mean",
      "Concavity Mean","Concave Points Mean","Symmetry Mean","Fractal Dimension Mean",
      "Radius SE","Texture SE","Perimeter SE","Area SE","Smoothness SE","Compactness SE","Concavity SE",
      "Concave Points SE","Symmetry SE","Fractal Dimension SE",
      "Radius Worst","Texture Worst","Perimeter Worst","Area Worst","Smoothness Worst",
      "Compactness Worst","Concavity Worst","Concave Points Worst","Symmetry Worst","Fractal Dimension Worst"
    ];

    // Mapping du dataset Breast Cancer (sklearn) : 0 = bénigne, 1 = Maligne
    const CLASS_LABELS = { 0: "Tumeur bégnine", 1: "Tumeur maligne" };
    // Optionnel : pour un texte encore plus court
    const CLASS_SHORT = { 0: "Bénigne", 1: "Maligne" };



    // -------- 2) Échantillons --------
    const EXAMPLE_VALUES = [
      [17.99,10.38,122.8,1001,0.1184,0.2776,0.3001,0.1471,0.2419,0.07871,1.095,0.9053,8.589,153.4,0.0064,0.0490,0.0537,0.0159,0.0303,0.0062,25.38,17.33,184.6,2019,0.1622,0.6656,0.7119,0.2654,0.4601,0.1189],
      [13.540,14.36,87.46,566.3,0.09779,0.08129,0.06664,0.047810,0.1885,0.05766,0.2699,0.7886,2.058,23.560,0.008462,0.014600,0.02387,0.013150,0.01980,0.002300,15.110,19.26,99.70,711.2,0.14400,0.17730,0.23900,0.12880,0.2977,0.07259],
      [20.57,17.77,132.90,1326.0,0.08474,0.07864,0.08690,0.07017,0.1812,0.05667,0.5435,0.7339,3.398,74.08,0.005225,0.01308,0.01860,0.01340,0.01389,0.003532,24.99,23.41,158.80,1956.0,0.1238,0.1866,0.2416,0.1860,0.2750,0.08902],
      [13.080,15.71,85.63,520.0,0.10750,0.12700,0.04568,0.031100,0.1967,0.06811,0.1852,0.7477,1.383,14.670,0.004097,0.018980,0.01698,0.006490,0.01678,0.0024215,14.500,20.49,96.09,630.5,0.13120,0.27760,0.18900,0.07283,0.3184,0.08183]
    ];

    // -------- 3) Utilitaires DOM / parsing --------
    const byId = (id)=>document.getElementById(id);
    const grid = byId('fields');
    const $msg = byId('msg');
    const $res = byId('result');
    const $resBadge = byId('res-badge');
    const $resY = byId('res-y');
    const $resProba = byId('res-proba');
    const $cfgBadge = byId('cfg-badge');
    const $cfgSpin = byId('cfg-spin');
    const $apiUrl = byId('api-url');

    function showMsg(txt, kind='muted'){ $msg.className=`msg ${kind}`; $msg.textContent=txt; }
    function showResult(obj){
      $res.style.display = 'block';

      const pred = Number(obj?.prediction);
      const probs = Array.isArray(obj?.probability) ? obj.probability : null;
      const probPred = (probs && Number.isFinite(probs[pred])) ? probs[pred] : null;

      // Texte brut (inchangé)
      $resY.textContent = Number.isFinite(pred) ? `${pred} (${CLASS_SHORT[pred] ?? "?"})` : '—';
      $resProba.textContent = probs ? JSON.stringify(probs) : '—';

      // Badge lisible + couleur
      if (pred === 0 || pred === 1){
        const label = CLASS_LABELS[pred] || '—';
        const pct = probPred != null ? ` — confiance ${(probPred*100).toFixed(1)}%` : '';
        $resBadge.textContent = `${label}${pct}`;
        $resBadge.className = `badge ${pred === 1 ? 'ok' : 'error'}`; // vert si bénigne, rouge si maligne
         }else{
         $resBadge.textContent = '—';
         $resBadge.className = 'badge';
         }
      }   
   
    function hideResult(){ $res.style.display='none'; $resBadge.textContent='—'; $resY.textContent='—'; $resProba.textContent='—'; }

    // virgule ou point
    function parseNumber(str){
      const s = (str ?? '').toString().trim().replace(',', '.');
      const v = Number(s);
      return Number.isFinite(v) ? v : NaN;
    }

    function getInputs(){ return Array.from(grid.querySelectorAll('input[data-feature-index]')); }
    function clearAll(){ getInputs().forEach(i=>i.value=''); showMsg(''); hideResult(); }

    function fillValues(arr){
      const inputs = getInputs();
      for (let i=0;i<inputs.length;i++){ inputs[i].value = (arr[i] ?? '').toString().replace('.', ','); }
      showMsg('Valeurs chargées.','ok');
      hideResult();
    }

    function buildUIIfEmpty(){
      if (grid.childElementCount) return;
      FEATURE_LABELS.forEach((label, i)=>{
        const wrap = document.createElement('div'); wrap.className='field';
        const lab  = document.createElement('label'); lab.htmlFor = `f${i}`; lab.textContent = `${i+1}) ${label}`;
        const inp  = document.createElement('input');
        inp.type='text'; inp.id=`f${i}`; inp.setAttribute('inputmode','decimal');
        inp.setAttribute('data-feature-index', i);
        inp.placeholder = 'Ex: 12,34';
        const hint = document.createElement('div'); hint.className='hint'; hint.textContent='Ex: 12,34 ou 12.34';
        wrap.append(lab, inp, hint); grid.appendChild(wrap);
      });
    }

    function prefillFromQuery(){
      const url = new URL(location.href);
      if (url.searchParams.get('sample')){
        const idx = Math.max(1, Math.min(4, Number(url.searchParams.get('sample')))) - 1;
        if (Number.isInteger(idx) && EXAMPLE_VALUES[idx]) fillValues(EXAMPLE_VALUES[idx]);
      } else if (url.searchParams.get('features')){
        try{
          const vec = parseFeaturesArg(url.searchParams.get('features'));
          if (vec.length === FEATURE_ORDER.length) fillValues(vec);
        }catch{}
      }
    }

    function parseFeaturesArg(raw){
      if (raw == null) throw new Error('features manquant');
      let s = raw.trim().replaceAll(';', ',');
      if (s.startsWith('[') && s.endsWith(']')){
        const arr = JSON.parse(s);
        return arr.map(x=>parseNumber(String(x)));
      }
      const parts = s.trim().replaceAll('[','').replaceAll(']','').split(/[\s,]+/).filter(Boolean);
      return parts.map(parseNumber);
    }

    // -------- 4) Chargement config (avec fallback + badge) --------
    window.__PREDICT_URL__ = undefined;

    function setCfgBadge(state, urlText){
      if (state==='ok'){
        $cfgBadge.className='badge';
        $cfgBadge.innerHTML = 'Config chargée';
        $cfgSpin.style.display='none';
        if (urlText) $apiUrl.textContent = urlText;
      }else if (state==='warn'){
        $cfgBadge.className='badge';
        $cfgBadge.innerHTML = 'Config par défaut';
        $cfgSpin.style.display='none';
        if (urlText) $apiUrl.textContent = urlText;
      }else if (state==='err'){
        $cfgBadge.className='badge';
        $cfgBadge.innerHTML = 'Config indisponible';
        $cfgSpin.style.display='none';
        if (urlText) $apiUrl.textContent = urlText;
      }else{
        $cfgBadge.className='badge';
        $cfgBadge.innerHTML = '<span class="spinner" id="cfg-spin"></span> Chargement configuration…';
      }
    }

    async function fetchWithTimeout(url, opt={}, ms=7000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), ms);
      try{
        const res = await fetch(url, {...opt, signal: ctrl.signal});
        return res;
      }finally{ clearTimeout(t); }
    }

    async function loadConfig(){
      const btn = byId('btn-submit'); if (btn) btn.disabled = true;
      setCfgBadge('loading');

      try{
        // No-cache pour être sûr
        const r = await fetchWithTimeout('/static/config.json', {cache:'no-store', headers:{'Cache-Control':'no-store'}}, 7000);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const cfg = await r.json();
        window.__PREDICT_URL__ = cfg?.predictUrl || `${location.origin}/predict`;
        setCfgBadge('ok', window.__PREDICT_URL__);
      }catch(e){
        // Fallback même origine
        console.warn('Config.json introuvable → fallback', e);
        window.__PREDICT_URL__ = `${location.origin}/predict`;
        setCfgBadge('warn', window.__PREDICT_URL__);
      }finally{
        if (btn) btn.disabled = false;
      }
    }

    // -------- 5) Soumission (retries) --------
    async function submitPrediction(){
      const inputs = getInputs();
      if (inputs.length !== FEATURE_ORDER.length){
        showMsg(`Formulaire incomplet : ${FEATURE_ORDER.length} champs requis.`, 'error'); return;
      }
      const vec = [];
      for (const inp of inputs){
        const v = parseNumber(inp.value);
        if (!Number.isFinite(v)){ inp.focus(); showMsg(`Valeur invalide (utilisez 12,34 ou 12.34).`, 'error'); hideResult(); return; }
        vec.push(v);
      }
      const url = window.__PREDICT_URL__;
      if (!url){ showMsg('Configuration manquante : "predictUrl" dans config.json.', 'error'); hideResult(); return; }

      const btn = byId('btn-submit'); btn.disabled = true;
      showMsg('Envoi en cours…', 'muted');
      hideResult();

      const payload = { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({features:vec}) };

      let lastErr = null;
      for (let attempt=1; attempt<=3; attempt++){
        try{
          const res = await fetchWithTimeout(url, payload, 10000);
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          try{
            sessionStorage.setItem('mlops:prediction', JSON.stringify(data));
            sessionStorage.setItem('mlops:prefill', JSON.stringify(vec));
          }catch{}
          showMsg('Prédiction effectuée.', 'ok');
          showResult(data);
          btn.disabled = false;
          return;
        }catch(err){
          lastErr = err;
          await new Promise(r=>setTimeout(r, 350*attempt)); // petit backoff
        }
      }

      showMsg(`Échec réseau/CORS : ${lastErr}`, 'error');
      btn.disabled = false;
    }

    // -------- 6) Init --------
    async function init(){
      buildUIIfEmpty();
      // Pré-remplissages
      try{
        // session (si on revient de résultat)
        const v = sessionStorage.getItem('mlops:prefill');
        if (v){
          const arr = JSON.parse(v);
          if (Array.isArray(arr) && arr.length===FEATURE_ORDER.length) fillValues(arr);
        }else{
          prefillFromQuery();
        }
      }catch{}

      // Branchements
      byId('btn-clear').addEventListener('click', clearAll);
      byId('btn-load').addEventListener('click', ()=>{ const i = Number(byId('ex-select').value)||0; fillValues(EXAMPLE_VALUES[i]); });
      byId('btn-ex-fill').addEventListener('click', ()=>{ const i = Number(byId('ex-select').value)||0; fillValues(EXAMPLE_VALUES[i]); submitPrediction(); });
      byId('btn-submit').addEventListener('click', submitPrediction);

      await loadConfig();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
